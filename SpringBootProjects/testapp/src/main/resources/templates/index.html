<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; color: #333; }
        .menu { text-align: center; margin: 30px 0; }
        .menu button {
            margin: 0 8px;
            padding: 10px 16px;
            font-size: bold 14px Arial;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .menu button:hover { background: #0056b3; }
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .hidden { display: none; }
        .form-group { margin: 15px 0; }
        label { display: inline-block; width: 120px; font-weight: bold; }
        input { padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }
        button:not(.menu button) {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
        }
        button:not(.menu button):hover { background: #218838; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: #007bff; color: white; }
        tr:nth-child(even) { background: #f8f9fa; }
    </style>
</head>
<body>
<div class="container">
    <h1>Product Management System</h1>

    <div class="menu">
        <button onclick="showSection('add')">Add Product</button>
        <button onclick="showSection('delete')">Delete Product</button>
        <button onclick="showSection('showAllProducts')">Show Products</button>
        <button onclick="showSection('findById')">Find by ID</button>
        <button onclick="showSection('findByName')">Find by Name</button>
    </div>

    <div class="content">
        <!-- Add Product -->
        <div id="add" class="section hidden">
            <h2>Add Product</h2>
            <div class="form-group"><label>Product Name:</label><input type="text" id="addName"></div>
            <div class="form-group"><label>Price:</label><input type="number" step="0.01" id="addPrice"></div>
            <div class="form-group"><label>Category:</label><input type="text" id="addCategory"></div>
            <div class="form-group"><label>Stock:</label><input type="number" id="addStock"></div>
            <button onclick="addProduct()">Add Product</button>
        </div>

        <!-- Delete Product -->
        <div id="delete" class="section hidden">
            <h2>Delete Product</h2>
            <div class="form-group"><label>Product ID:</label><input type="number" id="deleteId"></div>
            <button onclick="deleteProduct()">Delete Product</button>
        </div>

        <!-- Show All Products -->
        <div id="showAllProducts" class="section hidden">
            <h2>All Products</h2>
            <button onclick="loadAllProducts()">Load Products</button>
            <div id="productsList"></div>
        </div>

        <!-- Find by ID -->
        <div id="findById" class="section hidden">
            <h2>Find Product by ID</h2>
            <div class="form-group"><label>Product ID:</label><input type="number" id="searchId"></div>
            <button onclick="findProductById()">Search</button>
            <div id="searchResultId"></div>
        </div>

        <!-- Find by Name -->
        <div id="findByName" class="section hidden">
            <h2>Find Product by Name</h2>
            <div class="form-group"><label>Product Name:</label><input type="text" id="searchName"></div>
            <button onclick="findProductByName()">Search</button>
            <div id="searchResultName"></div>
        </div>
    </div>
</div>

<script>
    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');
    }

    // FIXED: Renamed to avoid conflict + improved
    async function loadAllProducts() {
        const container = document.getElementById('productsList');
        const button = container.previousElementSibling;

        button.disabled = true;
        button.textContent = 'Loading...';
        container.innerHTML = '<p>Loading products...</p>';

        try {
            const res = await fetch('/api/products');
            if (!res.ok) throw new Error('Failed: ' + res.status);

            const products = await res.json();
            if (products.length === 0) {
                container.innerHTML = '<p>No products found.</p>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th>';
            html += '</tr></thead><tbody>';

            products.forEach(p => {
                html += `<tr>
                    <td>${p.id || ''}</td>
                    <td>${p.name || ''}</td>
                    <td>${p.category || '-'}</td>
                    <td>$${Number(p.price).toFixed(2)}</td>
                    <td>${p.stock ?? '-'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
            console.error(e);
        } finally {
            button.disabled = false;
            button.textContent = 'Load Products';
        }
    }

    async function addProduct() {
        const name = document.getElementById('addName').value.trim();
        const price = document.getElementById('addPrice').value.trim();
        const category = document.getElementById('addCategory').value.trim();
        const stock = document.getElementById('addStock').value.trim();

        if (!name || !price) return alert('Name and Price are required!');

        const product = {
            name,
            price: parseFloat(price),
            category: category || null,
            stock: stock ? parseInt(stock, 10) : null
        };

        try {
            const res = await fetch('/api/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(product)
            });

            if (!res.ok) throw new Error(await res.text());

            alert('Product added successfully!');
            document.getElementById('addName').value = '';
            document.getElementById('addPrice').value = '';
            document.getElementById('addCategory').value = '';
            document.getElementById('addStock').value = '';

            // Auto-refresh if we're on the "Show Products" tab
            if (!document.getElementById('showAllProducts').classList.contains('hidden')) {
                loadAllProducts();
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }

    async function deleteProduct() {
        const id = document.getElementById('deleteId').value.trim();
        if (!id) return alert('Enter ID');
        if (!confirm(`Delete product ID ${id}?`)) return;

        try {
            const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error(await res.text() || res.status);

            alert('Deleted successfully!');
            document.getElementById('deleteId').value = '';

            if (!document.getElementById('showAllProducts').classList.contains('hidden')) {
                loadAllProducts();
            }
        } catch (e) {
            alert('Delete failed: ' + e.message);
        }
    }
async function findProductById() {
        const id = document.getElementById('searchId').value.trim();
        const result = document.getElementById('searchResultId');
        if (!id) return alert('Enter ID');

        result.innerHTML = '<p>Searching...</p>';

        try {
            const res = await fetch(`/api/products/${id}`);
            if (res.status === 404) {
                result.innerHTML = '<p style="color:#999">Product not found</p>';
                return;
            }
            if (!res.ok) throw new Error(await res.text());

            const p = await res.json();

            result.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${p.id || ''}</td>
                            <td>${p.name || ''}</td>
                            <td>${p.category || '-'}</td>
                            <td>$${Number(p.price).toFixed(2)}</td>
                            <td>${p.stock ?? '-'}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        } catch (e) {
            result.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
            console.error(e);
        }
    }

    async function findProductByName() {
        const name = document.getElementById('searchName').value.trim();
        const result = document.getElementById('searchResultName');
        if (!name) return alert('Enter name');

        result.innerHTML = '<p>Searching...</p>';
        try {
            const res = await fetch(`/api/products/search?name=${encodeURIComponent(name)}`);
            if (!res.ok) throw new Error(await res.text());

            const products = await res.json();
            if (!products.length) return result.innerHTML = '<p>No products found</p>';

            let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th></tr></thead><tbody>';
            products.forEach(p => {
                html += `<tr>
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>${p.category || '-'}</td>
                    <td>$${Number(p.price).toFixed(2)}</td>
                    <td>${p.stock ?? '-'}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            result.innerHTML = html;
        } catch (e) {
            result.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
        }
    }
</script>
</body>
</html>